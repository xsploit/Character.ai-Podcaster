// SPDX-FileCopyrightText: 2024 LiveKit, Inc.
//
// SPDX-License-Identifier: Apache-2.0
import EventEmitter from 'events';
import { AudioFrame } from './audio_frame.js';
import { FfiClient, FfiClientEvent, FfiHandle } from './ffi_client.js';
import { AudioStreamType, NewAudioStreamRequest } from './proto/audio_frame_pb.js';
export var AudioStreamEvent;
(function (AudioStreamEvent) {
    AudioStreamEvent["FrameReceived"] = "frameReceived";
})(AudioStreamEvent || (AudioStreamEvent = {}));
export class AudioStream extends EventEmitter {
    constructor(track) {
        super();
        this.onEvent = (ev) => {
            if (ev.message.case != 'audioStreamEvent' ||
                ev.message.value.streamHandle != this.ffiHandle.handle) {
                return;
            }
            const streamEvent = ev.message.value.message;
            switch (streamEvent.case) {
                case 'frameReceived':
                    const frame = AudioFrame.fromOwnedInfo(streamEvent.value.frame);
                    this.emit(AudioStreamEvent.FrameReceived, { frame });
                    break;
                case 'eos':
                    FfiClient.instance.off(FfiClientEvent.FfiEvent, this.onEvent);
                    break;
            }
        };
        this.track = track;
        const req = new NewAudioStreamRequest({
            type: AudioStreamType.AUDIO_STREAM_NATIVE,
            trackHandle: track.ffi_handle.handle,
        });
        const res = FfiClient.instance.request({
            message: {
                case: 'newAudioStream',
                value: req,
            },
        });
        this.info = res.stream.info;
        this.ffiHandle = new FfiHandle(res.stream.handle.id);
        FfiClient.instance.on(FfiClientEvent.FfiEvent, this.onEvent);
    }
    close() {
        this.ffiHandle.dispose();
    }
}
//# sourceMappingURL=audio_stream.js.map